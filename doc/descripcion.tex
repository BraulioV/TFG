\chapter{Descripción del sistema y requisitos}

\section{Descripción del sistema}

Este sistema está pensado para resolver uno de los problemas que existen cada año en las distintas facultades, y es el generar los horarios para el próximo curso. Actuálmente, los horarios, al menos en la Escuela Técnica Superior de Ingeniería Informática y Telecomunicaciones, se hacen de forma totalmente manual, lo que supone un coste en tiempo muy grande y una gran cantidad de quebraderos de cabeza para la persona encargada. 

La solución actual que se le ha dado a este problema es la de partir de un horario ya creado, es decir, partir de la base del horario del año anterior y rotarlo. Esto quiere decir, que las asignaturas que había el lunes pasan al martes, la del martes al miércoles, etc. y el viernes pasa a ser el lunes. Esto genera un nuevo horario, en el que pueden surgir problemas por las aulas del centro, y que luego, habrá que modificar a posteriori.

Esto a su vez trae otra serie de consecuencias, y es que el generar un nuevo horario desde cero es muy costoso, por lo que todos los años habrá una estructura similar en lo que se refiere a la asignación de horas de prácticas y teoría. Esto implica que no se pueda ``experimentar'' con el horario para generar, por ejemplo, un horario en el que la jornada se ve alargada y se reduce en uno el número de días a la semana lectivos.

Esto es de utilidad en el caso de si se desea impartir una nueva titulación en el centro y se quiere comprobar de antemano si introducir una nueva titulación es posible, ya no por los profesores, sino por la propia estructura del centro, ya que, puede ser que posible que ajustando el horario, la jornada y la asignación de aulas, se pueda dar cabida a una nueva titulación en el centro.

Esto nos lleva a un nuevo problema que surge durante la generación de un nuevo horario, y es la gestión de aulas de las que dispone el centro, que es casi tan importante como la propia estructura del horario. Esto se debe a que es igual de importante el que los grupos tengan aulas de teoría suficientes como para poder cursar las horas de teoría, como el que existan suficientes aulas de prácticas o laboratorios como para albergar a todos los subgrupos de prácticas que existen. También es sumamente importante el no saturar ni las aulas de teoría ni las aulas de prácticas, ya que esto llevaría a un mal funcionamiento del centro, y por ende, a un mal horario.

% ya que es tan importante que todos los grupos tengan aulas de teoría asignadas para poder cursar las horas de teoría que tenga cada asignatura, como las aulas de prácticas o laboratorios que existen para cursar estas horas de prácticas, como el no saturar ni las aulas de prácticas ni las de teoría, ya que esto llevaría a un mal funcionamiento del centro.

Realizar esta tarea a mano, como se viene haciendo hasta ahora, supone un gran esfuerzo mental, ya que no es una tarea fácil, y un alto coste en lo que se refiere al tiempo de dedicación que necesita esta tarea, ya que la cantidad de restricciones que existen es muy alta, y el número de posibilidades aún mayor, debido a que este problema es básicamente un problema de optimización combinatoria.

Por lo tanto, este sistema ofrece una solución tanto al problema de la generación de un horario estándar para la escuela, como la posibilidad de poder realizar pruebas tipo ``\textit{¿Qué pasaría si...?}'' y el problema de asignación de aulas, de forma automática y lo más eficiente posible.

% La idea general del sistema es ofrecer una forma automatizada de hacer los horarios de una escuela o facultad en base a restricciones tales como el profesorado y su disponibilidad, las aulas disponibles teniendo en cuenta su capacidad y el equipo del que disponen, el número de alumnos de una asignatura, bloques horarios, etc. 

% Con este sistema podrán estudiarse distintas propuestas de horarios para maximizar el uso de las aulas, el rendimiento de todo el equipo de una facultad y facilitar el trabajo que supone la creación de un horario para cada nuevo curso.

% \section{Objetivos principales del sistema}

% \begin{enumerate}[OBJ-1]
%     \item El usuario debe introducir la menor información posible para que le resulte más cómodo y sencillo hacer uso del sistema. Esto sería posible si la mayoría de información necesaria para la generación del horario fuera posible obtenerla de la base de datos de la escuela o de la UGR, para evitar que el usuario tenga que realizar ninguna entrada desde ficheros o similares.
    
%     \item Tener la posibilidad de realizar un nuevo horario desde cero a partir de los datos disponibles, y la posibilidad de, a partir de uno ya generado, generar uno nuevo a partir de modificaciones.

%     \item Sobre la solución del sistema, existen dos opciones:
%     \begin{enumerate}[a)]
%         \item Ofrecer una única solución y ofrecer la posibilidad de realizar modificaciones sobre esta de forma interactiva y que el sistema avise de posibles conflictos.
%         \item Ofrecer como salida un parapeto de soluciones que haya encontrado el sistema y que el usuario final elija entre las soluciones que más le interesen.
%     \end{enumerate}
%     % \item Poder conectarse a las bases de datos de la universidad de forma que el usuario introduzca la menor información posible.
%     % \item Poder crear un horario válido desde cero usando los datos disponibles.
%     % \item Una vez hecha una propuesta de horario, realizar modificaciones sobre la misma de forma que se obtenga un horario válido.
% \end{enumerate}

\section{Requisitos del sistema}

Antes de comenzar el desarrollo de este sistema, recogimos una lista de requisitos que debía cumplir el sistema, para que realizara su tarea de forma adecuada. Esta tarea se llevó a cabo realizando entrevistas con nuestro tutor, que a su vez es el director de la escuela, lo que supone una alta relación en la tarea de la generación de horarios para cada curso. 

Para completar y comprobar que estos requisitos son correctos, nuestro tutor nos recomendó que fueramos a hablar con Dº Jesús García Miranda, que fue quien hizo la estructura actual que tienen en la escuela, y quien se encarga principalmente de hacer los horarios todos los años para cada curso. Gracias a él, pudimos obtener una lista más extensa de requisitos que tenía que cumplir estrictamente el sistema, y corregir algunos de los que teníamos previamente. 

A continuación, podemos ver la lista de requisitos que tiene este sistema.

\begin{enumerate}[REQ-1]
    \item No pueden solaparse dos asignaturas el mismo día y a la misma hora en el mismo aula.
    \item Cómo máximo hay tres subgrupos de prácticas. Puede haber asignaturas en las que haya dos subgrupos y otras en las que haya sólo uno.
    \item Para cada grupo de teoría se debe decidir de forma manual su franja horaria, es decir, qué horario tendrá, y el aula de teoría que se le quiere asignar a ese grupo.
    %\item No puede haber más de tres grupos de teoría asignados al mismo aula en el mismo turno (mañana o tarde), pudiendo convivir de uno a tres grupos. 
    \item Se debe saber de antemano el número de horas de teoría y prácticas de cada asignatura.
    \item Si el número de horas de prácticas de una asignatura es impar, se agrupará con otra asignatura que esté en la misma situación, generando un ``bloque''. Esto puede generar un problema en la generación del horario y es que puede ser que alguna hora de una asignatura sea imposible cuadrarla en el horario con las demás, por lo que esta hora se añadirá al principio o al final del turno según lo que elija el usuario de forma manual. Esta situación se puede evitar si las horas de prácticas las imparten profesores diferentes. El objetivo es conseguir un \textbf{equilibrio horas/día}, es decir, evitar agrupar en un día muchas otras dejando otro prácticamente vacío. 
    \item Se debe dar la posibilidad de para una asignatura, elegir si impartir las horas de teoría en un mismo turno de dos o más horas, o repartir las sesiones de teoría a lo largo de la semana en días distintos.
    \item El horario obtenido para cada grupo no debe de contener huecos, es decir, debe ser lo más compacto posible.
    \item Las distintas especialidades tienen su horario en paralelo para no favorecer ninguna especialidad sobre otra. 
    \item Se debe registrar el equipamiento disponible en cada laboratorio y el que cada asignatura necesita para llevar a cabo sus prácticas de forma que el sistema realice la asignación a laboratorios de forma automática en función del equipamiento que tiene el aula y del que necesita la asignatura. 
    \item Se debe poder elegir el número de días y la franja horaria para cada titulación por separado, dando la posibilidad de incluir restricciones fuertes de horas y días para ciertas titulaciones, como es el caso del Doble Grado en Ingeniería Informática y Matemáticas, donde su horario puede ocupar una franja completa ($8:30-14:30$).
    \item Se necesita saber en todo momento qué horas tienen disponibles las aulas del centro, para poder asignar una asignatura o no a un aula en concreto, dependiendo de si tiene horas libres como para albergar esa asignatura o no.
    \item El usuario siempre podrá cambiar de forma manual el resultado del sistema, siempre y cuando no se produzcan colisiones en el horario.
\end{enumerate}

\section{Interacción de los distintos elementos}

Una vez obtenidos y verificados los requisitos que debe cumplir el sistema, pasamos a realizar un análisis de estos en profundidad. De este análisis, extraímos cuatro elementos fundamentales que interactúan entre sí. Estos cuatro elementos podemos verlos a continuación.

% A partir de los requisitos extraídos anteriormente, vemos que hay cuatro elementos fundamentales que interaccionan entre sí:

\begin{enumerate}[---]
    
    \item \textbf{Grupo}: representa un grupo de teoría (o \textit{grupo grande}) al que se le asigna de forma manual un único aula de teoría. En los casos en los que el número de matriculados en una o más de las asignaturas del grupo se dispare, será necesario asignar otro aula de teoría distinta. Por tanto, \textbf{puede darse la excepción de que un grupo tenga asignadas dos aulas de teoría}. Esto puede darse sobre todo en los grupos que tengan asignadas aulas con una menor capacidad, como puede ser en el grado de Ingeniería Informática, donde el número de alumnos en ciertas asignaturas se ha disparado de una especialidad se han disparado, y tienen asignadas como aulas de teoría una de la primera planta con menor capacidad, y otra de la planta baja con mucha más capacidad.
    
    \item \textbf{Aula de teoría}: representa un aula en las que se impartirán las clases de teoría para los grupos grandes. A estas aulas se le pueden asignar varios grupos de teoría en función de las horas disponibles que tenga. A cada grupo de teoría se le preasigna un aula de este tipo antes de comenzar la elaboración del horario, para reducir la complejidad del problema.

    \item \textbf{Aula de prácticas}: define los distintos laboratorios de prácticas, junto al \textbf{material} del que disponen. Hay que tener en cuenta, que algunas aulas de teoría pueden ser a la vez aulas de prácticas. Un ejemplo de ello son las aulas que hay en la primera planta del aulario de la Escuela.

    \item \textbf{Asignatura}: representa las distintas asignaturas que se imparten en cada curso, junto con sus horas de prácticas y teoría, el material que necesita y más aspectos específicos las asignaturas, como puede ser el año en que se imparte, especialidad, número de alumnos, etc. Datos útiles para la generación del horario.

    \item \textbf{Grupo de prácticas}: es un subgrupo que existe por haber una conexión de un grupo de teoría con uno de prácticas, puediendo existir más de un subgrupo de prácticas para una asignatura asignada a un grupo. Siempre se sabe a priori el número de grupos de prácticas que tendrá una asignatura, aunque pueden crearse o destruirse nuevos si fuese necesario, dependiendo de si hay alumnos suficientes como para tener $n$ subgrupos de prácticas o no.
\end{enumerate}

\begin{figure}[!h]
    \centering
    \input{interaccion.tex}
    \caption{Interacción de los diferentes elementos del sistema}
    \label{interaccion}
\end{figure}

En la \hyperref[interaccion]{Figura \ref*{interaccion}} vemos un esquema de la interacción de los diferentes elementos del sistema entre sí, en un diagrama de clases simplificado del problema, para mejorar la interpretación de la idea general. 

En primer lugar, el usuario debe asignar manualmente a cada grupo el aula de teoría correspondiente, para proporcionarle a los algoritmos que vienen detrás un punto de partida que se ajuste lo mejor posible a lo que se desea como resultado. Actuálmente, esta asignación de aulas la hemos cogido de la asignación que existe actuálmente en el horario de este año, consultándolo con Jesús García Miranda. De esta forma, podríamos ajustar el sistema para que los resultados de los algoritmos hicieran horarios similares a los que hay ahora en nuestra escuela, pero con la optimización que hace el algoritmo detrás.

Una vez finalizada la asignación de aulas a los grupos de teoría, el sistema comenzará a crear el horario para el curso, comenzando primero asignado las horas de teoría, para después pasar a asignar los subgrupos de prácticas, comprobando qué aula y hora les corresponden para cada asignatura, cumpliendo con las restricciones de material que imponga cada asignatura, y de que no ocurran solapamientos.

Para cuadrar las horas de forma eficiente es necesario tener una estructura de datos adicional (una tabla hash o un diccionario) en el que se tenga constancia de las asignaciones que ha recibido un aula, el número de horas disponibles que tiene y cuándo las tiene disponibles. En nuestro caso, esta estructura es una matriz 2D de tamaño $(n_{horas} \times n_{dias})$, en la que se irán marcando para cada hora y día cúando el aula está ocupada o no.

\begin{figure}[!h]
    \centering
    \input{clases2.tex}
    \caption{Diagrama que representa cada uno de los elementos esenciales del sistema junto con la información que almacenan}
    \label{clases}
\end{figure}

A partir del diagrama de interacción (\hyperref[interaccion]{Figura \ref*{interaccion}}) hemos extraído una serie de clases que representan cada uno de los elementos junto con la información que deben almacenar. Dicho diagrama está representado en la \hyperref[clases]{Figura \ref*{clases}} y destacamos los siguientes aspectos:

\begin{enumerate}[$\bullet$]
    \item El elemento \textit{Aula de teoría} está representado por la clase \textit{Aula}, que almacena la capacidad de la misma y su nombre. El elemento \textit{Aula de prácticas} es una especialización de la clase \textit{Aula}, que además almacena el material del que dispone ese laboratorio. Para representar los materiales que almacena un aula, hemos decidido usar un conjunto de elementos de tipo \textit{string}, ya que esto nos permite hacer operaciones como pueden ser la intersección, que nos será útil para asignar aulas de prácticas a ciertas asignaturas, en función de los materiales que albergue.

     \item El atributo referente al \textit{número de subgrupos de prácticas} está colocado tanto en la clase \textit{Grupo} ya que será éste quien conoce el número de alumnos matriculados en este grupo. Por ejemplo, el grupo A de una asignatura puede tener 100 matriculados y el grupo F, 50. Por tanto al grupo A le corresponderían 3 grupos de prácticas mientras que al F sólo 2.

     A pesar de esto, pueden existir ciertas asignaturas que para un cierto grupo, el número de alumnos sea mucho mayor que en el resto de asignaturas. En este caso, tras una consulta con nuestro tutor, se decidió que para estas excepciones, el nuevo grupo se asignaría una vez hecho el horario de forma manual, gracias a la interfaz. 
    % \begin{enumerate}[---]
    %     \item \textbf{Grupo}: cada grupo tiene un número distinto de alumnos. Por ejemplo, el grupo A de una asignatura puede tener 100 matriculados y el grupo F, 50. Por tanto al grupo A le corresponderían 3 grupos de prácticas mientras que al F sólo 2.
    %     \item \textbf{Asignatura}: cada asignatura de un mismo grupo puede tener un número distinto de alumnos matriculados: no es lo mismo una asignatura obligatoria que una asignatura optativa. Además, al hacer el horario no sabemos el número de alumnos matriculados sino las plazas ofertadas, y en caso de no llenar todas las plazas, siempre está la opción de corregir el horario manualmente.
    % \end{enumerate}
    % Respecto a esto, hemos decidido hacer una mezcla de ambas opciones. En cada asignatura de un grupo determinado habrá un número de alumnos matriculados que no tiene que ser igual al número de alumnos matriculados en otra asignatura en ese mismo grupo. Por tanto, será el grupo quién decida, para cada asignatura, el número de subgrupos de prácticas que tendrá.
\end{enumerate} 

\section{Planificación y desarrollo del proyecto}

Para el desarrollo del proyecto, planificamos una serie de objetivos y la realización de dichos objetivos, para llevar un control más exhaustivo del desarrollo del proyecto. A continuación, en la \hyperref[desarrollo]{Tabla \ref*{desarrollo}} podemos ver un diagrama de la planificación que seguimos para el desarrollo del proyecto.
\begin{table}[H]
\begin{center}
\begin{tabular}{c | c | c}
\textbf{Mes} & \textbf{Tarea} & \textbf{Tiempo estimado} \\
\hline
Noviembre & Primeras reuniones para definir & Dos reuniones \\
& el sistema y sus requisitos &  un mes \\
Diciembre & Diseño de un primer prototipo & Dos meses \\
Febrero & Reuniones mostrando el prototipo  & Tres reuniones\\
& para pulir detalles & un mes \\
Marzo & Implementación del primer prototipo & Dos meses \\
Mayo & Reunión mostrando el prototipo  & Una reunión \\
& implementado para pulir detalles & dos semanas \\
Mayo & Implementación de una primera & Un mes \\
& versión sin interfaz de usuario & \\
Junio & Diseño de la interfaz de usuario & Un mes \\
Julio & Implementación de la interfaz de usuario & Un mes \\
Agosto & Despliegue de la aplicación y primeras pruebas & Un mes \\
\end{tabular}
\end{center}
\caption{Planificación del proyecto}
\label{desarrollo}
\end{table}

Esta es la planificación que fijamos para ir desarrollando el proyecto. Como se puede ver en la \hyperref[desarrollo]{Tabla \ref*{desarrollo}}, la planificación llega hasta el mes de Agosto. Esto se decidió así debido a que el desarrollo del proyecto del proyecto había que hacerlo en paralelo al desarrollo del curso, y en las últimas etapas del proyecto, se relajó un poco la planificación debido a que había que compaginar el trabajo con el desarrollo del proyecto.

A lo largo de las primeras reuniones, se definieron todos los requisitos que había para el proyecto, y se decidieron cuáles era factibles implementar y cuales no, como puede ser el tener en cuenta que un profesor para una asignatura en concreto, pueda elegir si quiere que las horas de teoría de su asignatura estén seguidas o repartidas a lo largo de la semana, objetivos que había que cumplir, y otros temas para el desarrollo, como fueron el lenguaje escogido, en este caso \textbf{Python}, las herramientas a usar, algoritmos.

Para el proyecto, se definieron dos objetivos muy claros, uno para cada una de las memorias:
\begin{enumerate}
    \item La base algorítmica del proyecto debe ofrecer soluciones de calidad en un tiempo máximo de 5 minutos, siendo deseable un tiempo de 2 minutos. Esto se debe principalmente a varias razones, y es que para el desarrollo de una aplicación académica o un estudio donde el objetivo es obtener la mejor solución posible y no existe una restricción de tiempo, o al menos no es tan importante, el tener un tiempo límite no es necesario. Sin embargo, este proyecto se definió como una aplicación que van a acabar usando usuarios reales en un entorno real, por lo que, para un usuario final, cuanto antes obtenga una solución mejor. 

    Es decir, una aplicación, que intente resolver un problema, puede darse el caso de que obtenga soluciones de una altísima calidad, pero la inversión en tiempo sea tan alta que no merece la pena estar esperando dos, tres o las horas necesarias para obtener una solución, cuando otra aplicación en un menor tiempo, ofrece soluciones de una calidad notable, que quizá no sean perfectas, pero en pocos segundos ofrecen una solución.

    Por tanto, se decidió que los algoritmos a usar deben estar lo bastante optimizados como para cumplir estas restricciones de tiempo.


    \item Interfaz y despliegue de la aplicación. Como se ha dicho antes, este proyecto está pensado para que lo usen usuarios reales, por lo que la interfaz debe cumplir con unos criterios de usabilidad para que la aplicación sea útil y cómoda al usuario, y que no le suponga a este problemas el llevar a cabo una ejecución y obtener soluciones a su problema. Además de esto, la aplicación \textbf{debe ser accesible tanto para dispositivos móviles, como para ordenadores}.

    Además de esto, el despliegue de la aplicación debe ser lo más cómodo posible, tanto si se va a realizar en una máquina que se use como servidor y al que se acceda a través de la web o en una máquina cualquiera, y que no supongan serios problemas de dependencias al intentar instalar la aplicación, ya que, cuantos más problemas puedan aparecer en la aplicación, menos atractiva será.
\end{enumerate}

Además de esto, un objetivo común que tienen ambas partes del proyecto es la \textbf{simulación}. El proyecto debe ser capaz de generar un horario completo para una semana como las que hay ahora mismo en el centro, es decir, 5 días a la semana, 10 horas de clase. Además de esto, el algoritmo debe ser capaz de, al menos, ser capaz de realizar simulaciones de generación de horarios completos en los que la semana tiene 4 días, aumentando el número de horas de la jornada. Esto es muy útil, ya que en caso de querer introducir una nueva titulación en un centro, habrá que reajustar horarios, o incluso si se quiere ajustar la semana para hacerla más corta.

Otra parte importante del desarrollo del proyecto fue la decisión de usar un sistema de control, como es \textbf{\textit{git}}, junto con \textit{GitHub}, que es donde se encuentra alojado el proyecto. Esto se debe a que al utilizar un sistema de control de versiones, podemos tener una rama principal de desarrollo, en este caso conocida como la rama \textit{master}, donde decidimos alojar las versiones estables del proyecto. A su vez, permite trabajar desde una a tantas personas como se quieran en el mismo proyecto, con un gran control del proyecto gracias a que cada usuario va haciendo \textit{commits} y esto queda registrado en el desarrollo del proyecto.

A su vez, permite la existencia de varias ramas, además de la rama master. Esto permite que cada una de las personas involucradas en el proyecto puedan crear una rama del proyecto y desarrollar libremente en ella, sin molestar al resto de compañeros en su desarrollo, lo que permite que varias personas trabajen al mismo tiempo sobre distintos temas, sin ``fastidiar'' el trabajo de otros.

A su vez, gracias a \textit{GitHub}, todo el desarrollo del código queda abierto al mundo, haciendo el proyecto visible y convirtiéndolo en un proyecto de Software Libre. Esto permite que cualquier persona que quiera ver cómo está implementado el proyecto lo pueda ver, sea libre de usarlo y además, cualquier persona puede sentirse libre de realizar colaboraciones al proyecto, ya sean de código, mejoras en la seguridad de la aplicación, sugerencias, creación de \textit{issues} para notificiar de problemas, mejoras... o hasta correciones ortográficas si las hubiera.

Esto permite que el proyecto pueda estar en constante desarrollo y mejora de este, gracias al uso de tecnologías abiertas y de los beneficios que aporta el hacer software libre, en vez de un software privativo.
\section{Función de evaluación}
La calidad de un horario depende de la calidad del horario obtenido para cada grupo de teoría. Por tanto, para simplificar el cálculo de la misma, hemos decidido \textbf{hacer una función de evaluación a nivel individual para cada grupo} y que la \textbf{función de evaluación final sea una combinación de estas} funciones de evaluación:

\begin{displaymath}
    fitness = \sum_{i=0}^N fitness_i \qquad\ \forall i \in Grupos
\end{displaymath}

Donde la función de evaluación deberá maximizar la siguiente fórmula:

\begin{displaymath}
    fitness_i = fitness_{huecos} + fitness_{fueras}
\end{displaymath}

donde se reflejan las condiciones que debe penalizar:

\begin{enumerate}[---]
    \item De forma muy grave que haya huecos en el horario. Para ello, aplicaremos la siguiente fórmula:
    \begin{displaymath}
        fitness_{huecos} = \frac{1}{2 \left( \sum_{i = 1}^N h_i \right)^2}
    \end{displaymath}
    Donde $i$ es un día de la semana y $h_i$, los huecos que hay en ese día.
    
    \item De forma más suave que haya asignaturas colocadas fuera de la franja horaria. Para ello, aplicaremos la siguiente fórmula:
    \begin{displaymath}
        fitness_{fueras} = \frac{1}{\sum_{i=1}^N f_i}
    \end{displaymath}
    Donde $i$ es un día de la semana y $f_i$, las asignaturas fuera de la franja horaria que hay ese día.
\end{enumerate}

Con esta función de evaluación hemos cubierto los requisitos de minimizar los huecos en el horario y que haya asignaturas que queden fuera de la franja horaria establecida. Esto, a su vez, nos sirve tanto como para medir la calidad de un algoritmo Greedy, como de un algoritmo \textit{Iterated Local Search}, conocidos como ILS, o el algoritmo genético que se encargará de optimizar estos horarios.
